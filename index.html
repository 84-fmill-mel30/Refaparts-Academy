<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refaccionaria Mill√°n | POS ELITE V48.2</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        :root { --red: #ff0000; --dark: #0a0a0a; --green: #0f0; --gold: #ffcc00; --blue: #00f3ff; }
        body { background: var(--dark); color: white; font-family: 'Roboto Mono', monospace; margin: 0; padding-bottom: 80px; }
        .header { background: #000; padding: 15px; border-bottom: 3px solid var(--red); text-align: center; box-shadow: 0 0 15px var(--red); }
        .container { padding: 15px; max-width: 800px; margin: auto; }
        .card { background: #111; padding: 15px; border-radius: 10px; border: 1px solid #333; margin-bottom: 20px; border-left: 5px solid var(--red); }
        input, select { width: 100%; padding: 12px; margin: 8px 0; background: #000; border: 1px solid #444; color: #fff; border-radius: 5px; outline: none; }
        .btn { background: var(--red); color: #fff; border: none; padding: 15px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer; font-family: 'Orbitron'; text-transform: uppercase; }
        table { width: 100%; border-collapse: collapse; font-size: 0.65rem; margin-top: 10px; }
        th, td { border: 1px solid #333; padding: 8px; text-align: left; }
        th { background: #222; color: var(--gold); }
        .badge { font-size: 0.6rem; padding: 2px 5px; border-radius: 3px; font-weight: bold; }
        #ticket { background: white; color: black; padding: 20px; font-family: 'Courier New', monospace; display: none; width: 280px; margin: 20px auto; border: 2px dashed #000; }
    </style>
</head>
<body>

<div class="header">
    <h1 style="font-family:'Orbitron'; color:var(--red); margin:0;">MILL√ÅN POS V48.2</h1>
</div>

<div class="container">
    <div class="card">
        <h3 style="color:var(--gold); margin-top:0; font-size:0.9rem;">üîç BUSCADOR DE EXISTENCIAS (2005-2024)</h3>
        <select id="sMarca">
            <option value="">-- Selecciona Marca --</option>
            <option value="nissan">NISSAN</option>
            <option value="vw">VOLKSWAGEN</option>
            <option value="chevrolet">CHEVROLET</option>
            <option value="ford">FORD</option>
        </select>
        <input type="text" id="sModelo" placeholder="Modelo (Ej: Tsuru, Jetta, Aveo)">
        <input type="text" id="sPieza" placeholder="Pieza (Ej: Bobina, Sensor, Marcha)">
        <button class="btn" onclick="buscarExistencia()">VERIFICAR STOCK</button>
        <div id="resBusqueda" style="margin-top:10px;"></div>
    </div>

    <div style="display:flex; gap:10px;">
        <button class="btn" style="background:var(--green); color:black;" onclick="toggleScanner()">üì∑ ESCANEAR</button>
        <button class="btn" style="background:#333;" onclick="toggleAdmin()">‚öôÔ∏è ADMIN</button>
    </div>

    <video id="video" style="width: 100%; display:none; border: 2px solid var(--green); margin-top:10px; border-radius:10px;"></video>

    <div id="adminPanel" style="display:none;" class="card">
        <h3 style="color:var(--gold);">üì¶ INVENTARIO MAESTRO</h3>
        <button class="btn" style="background:var(--blue); color:black; margin-bottom:10px;" onclick="resetInventario()">‚ôªÔ∏è REINICIAR BASE DE DATOS</button>
        <div id="inventarioTabla" style="overflow-x:auto;"></div>
    </div>

    <div id="ticket">
        <center>
            <b>REFACCIONARIA MILL√ÅN</b><br>
            <small>Xochitepec, Morelos</small><br>
            --------------------------<br>
            <div id="ticketData"></div>
            --------------------------<br>
            <b>TOTAL: <span id="ticketTotal"></span></b><br><br>
            ¬°VENTA EXITOSA!
        </center>
        <button onclick="window.print()" style="width:100%; margin-top:10px;">IMPRIMIR TICKET</button>
    </div>
</div>

<script>
    // --- MOTOR DE DATOS MILL√ÅN ---
    let inventario = JSON.parse(localStorage.getItem('millan_stock')) || [];

    function inicializarBase() {
        const marcas = ["nissan", "vw", "chevrolet", "ford"];
        const catalogo = {
            "nissan": ["Tsuru III", "Sentra", "March", "Versa", "NP300"],
            "vw": ["Jetta A4", "Jetta A6", "Vento", "Golf", "Pointer"],
            "chevrolet": ["Chevy C2", "Aveo", "Spark", "Silverado"],
            "ford": ["Fiesta", "Figo", "F-150", "EcoSport"]
        };
        const piezas = [
            {n: "Bobina de Encendido", p: 750},
            {n: "Sensor CKP", p: 580},
            {n: "Sensor MAF", p: 1450},
            {n: "Marcha", p: 1850},
            {n: "Alternador", p: 2600},
            {n: "Bomba Gasolina", p: 1100}
        ];

        let nuevoStock = [];
        marcas.forEach(m => {
            catalogo[m].forEach(mod => {
                piezas.forEach(pie => {
                    nuevoStock.push({
                        id: "MIL-" + Math.random().toString(36).substr(2, 4).toUpperCase(),
                        marca: m,
                        modelo: mod,
                        a√±o: "2005-2024",
                        pieza: pie.n,
                        precio: pie.p,
                        stock: 5,
                        codigo: "750" + Math.floor(Math.random() * 1000000)
                    });
                });
            });
        });
        inventario = nuevoStock;
        localStorage.setItem('millan_stock', JSON.stringify(inventario));
        location.reload(); 
    }

    if (inventario.length === 0) inicializarBase();

    function buscarExistencia() {
        const m = document.getElementById('sMarca').value;
        const mod = document.getElementById('sModelo').value.toLowerCase();
        const p = document.getElementById('sPieza').value.toLowerCase();
        
        const encontrados = inventario.filter(i => 
            (i.marca === m || m === "") && 
            i.modelo.toLowerCase().includes(mod) &&
            i.pieza.toLowerCase().includes(p)
        );

        const res = document.getElementById('resBusqueda');
        res.innerHTML = encontrados.length > 0 ? encontrados.map(i => `
            <div style="background:#222; padding:12px; margin-top:8px; border-radius:5px; border-left:3px solid var(--green);">
                <b style="color:var(--gold);">${i.pieza}</b><br>
                <small>${i.marca.toUpperCase()} ${i.modelo} (${i.a√±o})</small><br>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                    <span>Stock: <b style="color:var(--green);">${i.stock}</b></span>
                    <span>$${i.precio}</span>
                    <button onclick="vender('${i.id}')" style="background:var(--gold); border:none; padding:5px 10px; border-radius:3px; font-weight:bold; cursor:pointer;">VENDER</button>
                </div>
            </div>
        `).join('') : "<p style='color:red; text-align:center;'>‚ùå NO ENCONTRADO EN STOCK</p>";
    }

    // --- SCANNER ---
    let codeReader = new ZXing.BrowserMultiFormatReader();
    function toggleScanner() {
        const v = document.getElementById('video');
        if (v.style.display === "none") {
            v.style.display = "block";
            codeReader.decodeFromVideoDevice(null, 'video', (result) => {
                if (result) {
                    v.style.display = "none";
                    codeReader.reset();
                    const p = inventario.find(i => i.codigo === result.text);
                    if(p) vender(p.id); else alert("C√≥digo no registrado: " + result.text);
                }
            });
        } else { v.style.display = "none"; codeReader.reset(); }
    }

    // --- VENTAS Y ADMIN ---
    function vender(id) {
        const p = inventario.find(i => i.id === id);
        if (p && p.stock > 0) {
            p.stock--;
            localStorage.setItem('millan_stock', JSON.stringify(inventario));
            document.getElementById('ticket').style.display = "block";
            document.getElementById('ticketData').innerHTML = `ART: ${p.pieza}<br>MOD: ${p.marca.toUpperCase()} ${p.modelo}<br>ID: ${p.id}`;
            document.getElementById('ticketTotal').innerText = "$" + p.precio;
            alert("Venta realizada. Stock actualizado.");
            buscarExistencia();
        } else { alert("¬°SIN EXISTENCIAS!"); }
    }

    function toggleAdmin() {
        const p = document.getElementById('adminPanel');
        p.style.display = p.style.display === "none" ? "block" : "none";
        renderTabla();
    }

    function renderTabla() {
        const div = document.getElementById('inventarioTabla');
        div.innerHTML = `<table>
            <tr><th>PIEZA</th><th>MOD</th><th>STK</th><th>$$</th></tr>
            ${inventario.slice(0, 50).map(i => `
                <tr><td>${i.pieza}</td><td>${i.marca[0].toUpperCase()}-${i.modelo}</td><td>${i.stock}</td><td>$${i.precio}</td></tr>
            `).join('')}
        </table><p style="font-size:0.5rem; color:gray;">Mostrando primeros 50 art√≠culos...</p>`;
    }

    function resetInventario() {
        if(confirm("¬øSeguro? Se borrar√°n tus cambios y volver√° al stock inicial.")) inicializarBase();
    }
</script>
</body>
</html>
