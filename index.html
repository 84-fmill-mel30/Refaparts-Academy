<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refaccionaria Mill√°n | POS V48.3</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        :root { --red: #ff0000; --dark: #0a0a0a; --green: #0f0; --gold: #ffcc00; }
        body { background: var(--dark); color: white; font-family: 'Roboto Mono', monospace; margin: 0; padding-bottom: 80px; }
        .header { background: #000; padding: 15px; border-bottom: 3px solid var(--red); text-align: center; box-shadow: 0 0 15px var(--red); }
        .container { padding: 10px; max-width: 800px; margin: auto; }
        .card { background: #111; padding: 15px; border-radius: 10px; border: 1px solid #333; margin-bottom: 15px; border-left: 5px solid var(--red); }
        input, select { width: 100%; padding: 12px; margin: 8px 0; background: #000; border: 1px solid #444; color: #fff; border-radius: 5px; outline: none; box-sizing: border-box; }
        .btn { background: var(--red); color: #fff; border: none; padding: 15px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer; font-family: 'Orbitron'; }
        .res-item { background: #222; padding: 12px; margin-top: 8px; border-radius: 5px; border-left: 3px solid var(--green); display: flex; justify-content: space-between; align-items: center; }
        #video { width: 100%; display:none; border: 2px solid var(--green); border-radius:10px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="header">
    <h1 style="font-family:'Orbitron'; color:var(--red); margin:0; font-size: 1.2rem;">MILL√ÅN POS V48.3</h1>
</div>

<div class="container">
    <div class="card">
        <h3 style="color:var(--gold); margin:0; font-size:0.9rem;">üîç BUSCADOR DE INVENTARIO</h3>
        <select id="sMarca">
            <option value="">-- Todas las Marcas --</option>
            <option value="nissan">NISSAN</option>
            <option value="vw">VOLKSWAGEN</option>
            <option value="chevrolet">CHEVROLET</option>
            <option value="ford">FORD</option>
            <option value="toyota">TOYOTA</option>
            <option value="honda">HONDA</option>
            <option value="mazda">MAZDA</option>
            <option value="kia">KIA / HYUNDAI</option>
            <option value="dodge">DODGE / JEEP</option>
            <option value="chinas">MG / CHIREY / JAC</option>
        </select>
        <input type="text" id="sModelo" placeholder="Modelo (Ej: Tsuru, Jetta, Aveo)">
        <input type="text" id="sPieza" placeholder="Pieza (Ej: Bobina, Sensor, Marcha)">
        <button class="btn" onclick="buscarExistencia()">VERIFICAR STOCK</button>
        <div id="resBusqueda" style="margin-top:10px;"></div>
    </div>

    <div style="display:flex; gap:10px;">
        <button class="btn" style="background:var(--green); color:black;" onclick="toggleScanner()">üì∑ ESCANEAR</button>
        <button class="btn" style="background:#333;" onclick="toggleAdmin()">‚öôÔ∏è ADMIN</button>
    </div>

    <video id="video"></video>

    <div id="adminPanel" style="display:none;" class="card">
        <h3 style="color:var(--gold);">üì¶ CONTROL DE STOCK</h3>
        <button class="btn" style="background:var(--gold); color:black; margin-bottom:10px;" onclick="inicializarBase()">‚ôªÔ∏è CARGAR COBERTURA TOTAL</button>
        <div id="inventarioTabla" style="overflow-x:auto; font-size: 0.7rem;"></div>
    </div>
</div>

<script>
    let inventario = JSON.parse(localStorage.getItem('millan_stock')) || [];

    function inicializarBase() {
        const marcasFull = ["nissan", "vw", "chevrolet", "ford", "toyota", "honda", "mazda", "kia", "dodge", "chinas"];
        const modelosPorMarca = {
            "nissan": ["Tsuru III", "Sentra", "March", "Versa", "NP300"],
            "vw": ["Jetta A4", "Jetta A6", "Vento", "Golf", "Pointer"],
            "chevrolet": ["Chevy C2", "Aveo", "Spark", "Silverado", "Sonic"],
            "ford": ["Fiesta", "Figo", "F-150", "EcoSport", "Focus"],
            "toyota": ["Hilux", "Corolla", "Tacoma"],
            "chinas": ["MG5", "ZS", "Tiggo 7"]
        };
        const piezasElectricas = [
            {n: "Bobina de Encendido", p: 750},
            {n: "Sensor CKP", p: 580},
            {n: "Sensor MAF", p: 1450},
            {n: "Marcha / Arranque", p: 1850},
            {n: "Alternador", p: 2600},
            {n: "Bomba Gasolina", p: 1100}
        ];

        let nuevoStock = [];
        marcasFull.forEach(m => {
            const mods = modelosPorMarca[m] || ["General"];
            mods.forEach(mod => {
                piezasElectricas.forEach(pie => {
                    nuevoStock.push({
                        id: "MIL-" + Math.random().toString(36).substr(2, 4).toUpperCase(),
                        marca: m,
                        modelo: mod,
                        a√±o: "2005-2024",
                        pieza: pie.n,
                        precio: pie.p,
                        stock: 1,
                        codigo: "750" + Math.floor(Math.random() * 1000000)
                    });
                });
            });
        });
        inventario = nuevoStock;
        localStorage.setItem('millan_stock', JSON.stringify(inventario));
        alert("¬°Base de Datos Cargada con √âxito!");
        location.reload();
    }

    // Si abres la app y est√° vac√≠a, se carga sola
    if (inventario.length === 0) inicializarBase();

    function buscarExistencia() {
        const m = document.getElementById('sMarca').value.toLowerCase();
        const modInput = document.getElementById('sModelo').value.toLowerCase();
        const pInput = document.getElementById('sPieza').value.toLowerCase();
        
        const filtrados = inventario.filter(i => {
            const matchMarca = m === "" || i.marca === m;
            const matchMod = modInput === "" || i.modelo.toLowerCase().includes(modInput);
            const matchPieza = pInput === "" || i.pieza.toLowerCase().includes(pInput);
            return matchMarca && matchMod && matchPieza;
        });

        const res = document.getElementById('resBusqueda');
        res.innerHTML = filtrados.length > 0 ? filtrados.slice(0, 10).map(i => `
            <div class="res-item">
                <div>
                    <b style="color:var(--gold); font-size:0.8rem;">${i.pieza.toUpperCase()}</b><br>
                    <small>${i.marca.toUpperCase()} ${i.modelo} (${i.a√±o})</small>
                </div>
                <div style="text-align:right;">
                    <span style="color:var(--green);">$${i.precio}</span><br>
                    <button onclick="vender('${i.id}')" style="background:var(--red); border:none; padding:4px 8px; border-radius:3px; color:white; font-size:0.6rem; font-weight:bold; cursor:pointer;">VENDER</button>
                </div>
            </div>
        `).join('') : "<p style='color:red; text-align:center;'>‚ùå No hay en stock f√≠sico. Verificando con proveedores...</p>";
    }

    function vender(id) {
        const p = inventario.find(i => i.id === id);
        alert(`Generando ticket para: ${p.pieza}\nTotal: $${p.precio}\n\n¬°Venta registrada!`);
    }

    function toggleAdmin() {
        const p = document.getElementById('adminPanel');
        p.style.display = p.style.display === "none" ? "block" : "none";
        renderTabla();
    }

    function renderTabla() {
        const div = document.getElementById('inventarioTabla');
        div.innerHTML = `<table><tr><th>Pieza</th><th>Mod</th><th>$$</th></tr>
            ${inventario.slice(0, 30).map(i => `<tr><td>${i.pieza}</td><td>${i.modelo}</td><td>$${i.precio}</td></tr>`).join('')}
        </table>`;
    }

    // Scanner simple
    let codeReader = new ZXing.BrowserMultiFormatReader();
    function toggleScanner() {
        const v = document.getElementById('video');
        if (v.style.display === "none") {
            v.style.display = "block";
            codeReader.decodeFromVideoDevice(null, 'video', (result) => {
                if (result) {
                    v.style.display = "none"; codeReader.reset();
                    alert("C√≥digo detectado: " + result.text);
                }
            });
        } else { v.style.display = "none"; codeReader.reset(); }
    }
</script>
</body>
</html>
